name: Update Calendar

on:
  schedule:
    # S'exécute tous les jours à 5h UTC (6h Paris heure d'hiver, 7h été)
    - cron: '0 5 * * *'
  workflow_dispatch:  # Permet de lancer manuellement depuis GitHub

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-calendar:
    runs-on: self-hosted

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Google Chrome
      run: |
        # Installer Google Chrome (pas Chromium snap)
        # --batch et --yes pour mode non-interactif (Docker)
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --batch --yes --dearmor -o /usr/share/keyrings/google-chrome.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable

    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt

    - name: Download existing calendar (backup)
      continue-on-error: true
      run: |
        # Télécharger l'ancienne version du calendrier comme backup
        curl -sSL -o edt_backup.ics "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/edt_m1_miage.ics" || echo "Pas de calendrier existant"
        if [ -f edt_backup.ics ] && [ -s edt_backup.ics ]; then
          echo "✓ Calendrier existant téléchargé comme backup"
          echo "BACKUP_EXISTS=true" >> $GITHUB_ENV
        else
          echo "⚠ Pas de calendrier existant à sauvegarder"
          echo "BACKUP_EXISTS=false" >> $GITHUB_ENV
        fi

    - name: Run public scraper
      id: scraper
      continue-on-error: true
      run: |
        python ade_public_scraper.py
        echo "SCRAPER_SUCCESS=true" >> $GITHUB_ENV

    - name: Check scraper result
      run: |
        if [ -f edt_m1_miage.ics ] && [ -s edt_m1_miage.ics ]; then
          EVENT_COUNT=$(grep -c "BEGIN:VEVENT" edt_m1_miage.ics || echo "0")
          echo "✓ Nouveau calendrier généré avec $EVENT_COUNT événements"
          if [ "$EVENT_COUNT" -gt "0" ]; then
            echo "USE_NEW=true" >> $GITHUB_ENV
          else
            echo "⚠ Calendrier vide, utilisation du backup"
            echo "USE_NEW=false" >> $GITHUB_ENV
          fi
        else
          echo "⚠ Scraper a échoué, utilisation du backup"
          echo "USE_NEW=false" >> $GITHUB_ENV
        fi

    - name: Use backup if scraper failed
      if: env.USE_NEW == 'false' && env.BACKUP_EXISTS == 'true'
      run: |
        echo "⚠ Utilisation du calendrier de backup"
        cp edt_backup.ics edt_m1_miage.ics

    - name: Fail if no calendar available
      if: env.USE_NEW == 'false' && env.BACKUP_EXISTS == 'false'
      run: |
        echo "❌ Aucun calendrier disponible (scraper échoué et pas de backup)"
        exit 1

    - name: Prepare GitHub Pages content
      run: |
        mkdir -p gh-pages
        cp edt_m1_miage.ics gh-pages/
        cat > gh-pages/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <title>M1 MIAGE FA-ALT - Emploi du temps</title>
          <meta charset="utf-8">
        </head>
        <body>
          <h1>Emploi du temps M1 MIAGE FA-ALT</h1>
          <p>Dernière mise à jour: $(date '+%Y-%m-%d %H:%M:%S UTC')</p>
          <p>URL du calendrier: <a href="edt_m1_miage.ics">edt_m1_miage.ics</a></p>
          <p>Pour ajouter à Apple Calendar ou Google Calendar, utilisez l'URL:</p>
          <code>https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/edt_m1_miage.ics</code>
        </body>
        </html>
        EOF

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: gh-pages
        publish_branch: gh-pages
        keep_files: false
